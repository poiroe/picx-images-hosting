name: 触发 poiroe.github.io 的更新

on:
  push:
    branches:
      - master

jobs:
  trigger-update:
    runs-on: ubuntu-latest

    steps:
      - name: 检出仓库
        uses: actions/checkout@v4.1.1

      - name: 检查上次触发时间
        run: |
          DELAY_FILE_PATH="delay"
          # 检查延迟文件是否存在
          if [ -f "$DELAY_FILE_PATH" ]; then
            # 获取延迟文件的创建时间
            CREATION_TIME=$(stat -c %Y "$DELAY_FILE_PATH")
            # 获取当前时间
            CURRENT_TIME=$(date +%s)
            # 计算时间差
            TIME_DIFF=$((CURRENT_TIME - CREATION_TIME))
            
            # 检查时间差是否小于1分钟
            if [ "$TIME_DIFF" -lt 60 ]; then
              echo "时间间隔小于1分钟。跳过工作流程。"
              exit 0
            fi
          fi

      - name: 触发更新
        run: |
          curl -XPOST \
            -H "Authorization: token ${{ secrets.PAT }}" \
            -H "Accept: application/vnd.github.everest-preview+json" \
            https://api.github.com/repos/poiroe/poiroe.github.io/dispatches \
            -d '{"event_type": "trigger-update"}'
        # 记录一条消息，指示触发已发送
        echo "触发更新已发送。"

      - name: 更新延迟文件
        run: |
          DELAY_FILE_PATH="delay"
          # 使用当前时间更新延迟文件的内容
          date +'%Y-%m-%dT%H:%M:%SZ' > "$DELAY_FILE_PATH"
        # 记录一条消息，指示延迟文件已更新
        echo "延迟文件已更新。"
